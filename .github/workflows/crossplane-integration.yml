name: Crossplane Integration Test

on:
  pull_request:
  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      kind_version:
        description: "Kind version to test (e.g. v0.30.0)"
        required: false
        default: "v0.30.0"
      cross_plan_version:
        description: "Crossplane CRDs version to test (e.g. v2.0.7)"
        required: false
        default: "v2.0.7"

jobs:
  crossplane-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Install kubectl
      # ------------------------------------------------------------
      - uses: azure/setup-kubectl@v4

      # ------------------------------------------------------------
      # Install helm
      # ------------------------------------------------------------
      - uses: azure/setup-helm@v4

      # ------------------------------------------------------------
      # Install kind
      # ------------------------------------------------------------
      - name: Install kind
        run: |
          KIND_VERSION="${{ inputs.kind_version }}"
          if [ -z "$KIND_VERSION" ]; then
            KIND_VERSION="v0.30.0"
          fi

          echo "Using kind version: $KIND_VERSION"

          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind --version

      # ------------------------------------------------------------
      # Create cluster
      # ------------------------------------------------------------
      - name: Create kind cluster
        run: kind create cluster --name crossplane-test

      # ------------------------------------------------------------
      # Install Crossplane CRDs (v2.1.4)
      # ------------------------------------------------------------
      - name: Apply Crossplane CRDs
        run: |
          set -e

          CROSS_PLAN_VERSION="${{ inputs.cross_plan_version }}"
          if [ -z "$CROSS_PLAN_VERSION" ]; then
            CROSS_PLAN_VERSION="v2.1.4"
          fi

          echo "Downloading Crossplane ${VERSION} source..."
          curl -L -o crossplane.tar.gz \
            https://github.com/crossplane/crossplane/archive/refs/tags/${CROSS_PLAN_VERSION}.tar.gz

          mkdir crossplane-src
          tar -xzf crossplane.tar.gz -C crossplane-src --strip-components=1

          echo "Installing CRDs from cluster/crds/ (create, not apply)..."
          kubectl create -f crossplane-src/cluster/crds/

          echo "CRDs applied successfully"
      # ------------------------------------------------------------
      # Install Crossplane (stable - Functions compatible)
      # ------------------------------------------------------------
      - name: Install Crossplane
        run: |
            set -e
            CROSS_PLAN_VERSION="${{ inputs.cross_plan_version }}"
            if [ -z "$CROSS_PLAN_VERSION" ]; then
              CROSS_PLAN_VERSION="v2.1.4"
            fi
            helm repo add crossplane-stable https://charts.crossplane.io/stable
            helm repo update
            helm install crossplane crossplane-stable/crossplane \
            --namespace crossplane-system \
            --create-namespace \
            --set "installCRDs=true" \
            --version ${CROSSPLANE_VERSION#v}

      # ------------------------------------------------------------
      # Wait Crossplane CRDs (Functions)
      # ------------------------------------------------------------
      - name: Wait Crossplane CRDs
        run: |
          kubectl wait --for=condition=Established \
            crd/functions.pkg.crossplane.io \
            --timeout=180s

      # ------------------------------------------------------------
      # Wait Crossplane ready
      # ------------------------------------------------------------
      - name: Wait Crossplane
        run: |
          kubectl wait --for=condition=available deployment \
            -n crossplane-system --all --timeout=180s

      # ------------------------------------------------------------
      # Install provider-kubernetes
      # ------------------------------------------------------------
      - name: Install provider
        run: kubectl apply -f providers/provider-kubernetes.yaml

      # ------------------------------------------------------------
      # Wait provider ready
      # ------------------------------------------------------------
      - name: Wait provider ready
        run: |
          kubectl wait --for=condition=Healthy \
            provider.pkg.crossplane.io/provider-kubernetes \
            --timeout=300s

      # ------------------------------------------------------------
      # Create ProviderConfig (in-cluster)
      # ------------------------------------------------------------
      - name: Create ProviderConfig
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: ProviderConfig
          metadata:
            name: default
          spec:
            credentials:
              source: InjectedIdentity
          EOF

      # ------------------------------------------------------------
      # Apply Functions (if using v2 pipeline mode)
      # ------------------------------------------------------------
      - name: Apply Functions
        run: |
          if [ -d "platform/functions" ]; then
            kubectl apply -f platform/functions/
          fi

      # ------------------------------------------------------------
      # Apply XRD
      # ------------------------------------------------------------
      - name: Apply XRD
        run: kubectl apply -f platform/xrd/

      # ------------------------------------------------------------
      # Apply Composition
      # ------------------------------------------------------------
      - name: Apply Composition
        run: kubectl apply -f platform/compositions/

      # ------------------------------------------------------------
      # Apply test claim
      # ------------------------------------------------------------
      - name: Apply test claim
        run: kubectl apply -f claims/example.yaml

      # ------------------------------------------------------------
      # Wait XTenant ready
      # ------------------------------------------------------------
      - name: Debug XTenant state
        run: |
          echo "---- XTenants ----"
          kubectl get xtenant -o wide || true

          echo "---- Describe XTenant ----"
          kubectl describe xtenant team-devops || true

          echo "---- Events ----"
          kubectl get events --sort-by=.metadata.creationTimestamp || true      
        

      # ------------------------------------------------------------
      # Verify namespace exists
      # ------------------------------------------------------------
      - name: Verify namespace
        run: kubectl get ns team-devops